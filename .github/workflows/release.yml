name: Release Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'uncommit.json'
      - 'hops-gui/Cargo.toml'
      - 'Package.swift'

permissions:
  contents: write

jobs:
  check-version:
    name: Check for version bump
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      prev_tag: ${{ steps.check.outputs.prev_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        id: check
        run: |
          get_version() {
            if [ -f "uncommit.json" ]; then
              echo "pkg_type=uncommit" >> $GITHUB_OUTPUT
              jq -r '.version' uncommit.json
            elif [ -f "hops-gui/Cargo.toml" ]; then
              echo "pkg_type=rust" >> $GITHUB_OUTPUT
              grep '^version' hops-gui/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/'
            elif [ -f "Package.swift" ]; then
              echo "pkg_type=swift" >> $GITHUB_OUTPUT
              grep -E 'let version.*=|version.*=' Package.swift | head -1 | sed 's/.*"\(.*\)".*/\1/'
            else
              echo ""
            fi
          }
          
          CURRENT_VERSION=$(get_version)
          echo "Current version: $CURRENT_VERSION"
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "No version file found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git show HEAD^:uncommit.json 2>/dev/null > /tmp/old_uncommit.json || true
          git show HEAD^:hops-gui/Cargo.toml 2>/dev/null > /tmp/old_cargo.toml || true
          git show HEAD^:Package.swift 2>/dev/null > /tmp/old_package.swift || true
          
          get_old_version() {
            if [ -f "uncommit.json" ] && [ -s /tmp/old_uncommit.json ]; then
              jq -r '.version' /tmp/old_uncommit.json 2>/dev/null || echo "0.0.0"
            elif [ -f "hops-gui/Cargo.toml" ] && [ -s /tmp/old_cargo.toml ]; then
              grep '^version' /tmp/old_cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo "0.0.0"
            elif [ -f "Package.swift" ] && [ -s /tmp/old_package.swift ]; then
              grep -E 'let version.*=|version.*=' /tmp/old_package.swift | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo "0.0.0"
            else
              echo "0.0.0"
            fi
          }
          
          PREV_VERSION=$(get_old_version)
          echo "Previous version: $PREV_VERSION"
          
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          
          if git ls-remote --tags origin | grep -q "refs/tags/v$CURRENT_VERSION"; then
            echo "Tag v$CURRENT_VERSION already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
            echo "Version changed from $PREV_VERSION to $CURRENT_VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  generate-notes:
    name: Generate AI release notes
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    outputs:
      release_notes: ${{ steps.generate.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes from code diff
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PREV_TAG="${{ needs.check-version.outputs.prev_tag }}"
          
          if [ -n "$PREV_TAG" ]; then
            echo "Getting diff from $PREV_TAG to HEAD"
            DIFF=$(git diff "$PREV_TAG"..HEAD -- '*.swift' '*.rs' 'Package.swift' 'hops-gui/Cargo.toml' 'uncommit.json' 2>/dev/null | head -c 80000 || echo "")
          else
            echo "No previous tag, getting diff from initial commit"
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            DIFF=$(git diff "$FIRST_COMMIT"..HEAD -- '*.swift' '*.rs' 'Package.swift' 'hops-gui/Cargo.toml' 'uncommit.json' 2>/dev/null | head -c 80000 || echo "")
          fi
          
          if [ -z "$DIFF" ] || [ "$DIFF" = "" ]; then
            if [ -n "$PREV_TAG" ]; then
              NOTES="## What's Changed

          See the [full changelog](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}) for details."
            else
              NOTES="## Release v${VERSION}

          Initial release."
            fi
            echo "$NOTES" > /tmp/release_notes.md
            echo "notes<<NOTES_EOF" >> $GITHUB_OUTPUT
            cat /tmp/release_notes.md >> $GITHUB_OUTPUT
            echo "NOTES_EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          SYSTEM="Generate release notes from code diffs. Rules:\n- No emojis\n- No title (GitHub shows it)\n- Minimal, concise, comprehensive\n- Only sections with changes (omit empty ones)\n- Markdown ## headers: Features, Fixes, Improvements, Breaking Changes\n- User-facing changes only\n- Version-only bump = \"Maintenance release.\""
          
          REQUEST=$(jq -n \
            --arg system "$SYSTEM" \
            --arg diff "Generate release notes for v$VERSION of hops (a lightweight sandboxing system for macOS using Apple's Containerization framework).\n\nCode diff:\n$DIFF" \
            '{
              "model": "gpt-5.2",
              "messages": [
                {
                  "role": "system", 
                  "content": $system
                },
                {
                  "role": "user",
                  "content": $diff
                }
              ],
              "max_completion_tokens": 2000
            }')
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$REQUEST")
          
          NOTES=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$NOTES" ]; then
            NOTES="Maintenance release."
          fi
          
          echo "$NOTES" > /tmp/release_notes.md
          
          echo "notes<<NOTES_EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.md >> $GITHUB_OUTPUT
          echo "NOTES_EOF" >> $GITHUB_OUTPUT

  create-tag:
    name: Create release tag
    runs-on: ubuntu-latest
    needs: [check-version, generate-notes]
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.check-version.outputs.version }}" -m "Release v${{ needs.check-version.outputs.version }}"
          git push origin "v${{ needs.check-version.outputs.version }}"

  create-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: [check-version, generate-notes, create-tag]
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - name: Create release with AI notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: v${{ needs.check-version.outputs.version }}
          body: ${{ needs.generate-notes.outputs.release_notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-swift:
    name: Build Swift binaries (macOS ARM64)
    runs-on: macos-latest
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Swift binaries
        run: |
          swift build -c release --arch arm64

      - name: Code sign hopsd
        run: |
          codesign -s - --entitlements hopsd.entitlements --force .build/arm64-apple-macosx/release/hopsd

      - name: Prepare binaries
        run: |
          mkdir -p dist
          cp .build/arm64-apple-macosx/release/hops dist/hops-macos-arm64
          cp .build/arm64-apple-macosx/release/hopsd dist/hopsd-macos-arm64
          cp .build/arm64-apple-macosx/release/hops-create-rootfs dist/hops-create-rootfs-macos-arm64
          chmod +x dist/*

      - name: Upload Swift binaries to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          files: |
            dist/hops-macos-arm64
            dist/hopsd-macos-arm64
            dist/hops-create-rootfs-macos-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-gui:
    name: Build GUI and create DMG (macOS ARM64)
    runs-on: macos-latest
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install protobuf compiler
        run: brew install protobuf

      - name: Build GUI
        working-directory: hops-gui
        run: cargo build --release --target aarch64-apple-darwin

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create app bundle
        run: |
          mkdir -p "Hops.app/Contents/MacOS"
          mkdir -p "Hops.app/Contents/Resources"
          cp hops-gui/target/aarch64-apple-darwin/release/hops-gui "Hops.app/Contents/MacOS/hops-gui"
          chmod +x "Hops.app/Contents/MacOS/hops-gui"
          
          cat > "Hops.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>hops-gui</string>
              <key>CFBundleIdentifier</key>
              <string>com.plyght.hops</string>
              <key>CFBundleName</key>
              <string>Hops</string>
              <key>CFBundleVersion</key>
              <string>${{ needs.check-version.outputs.version }}</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ needs.check-version.outputs.version }}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>15.0</string>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Hops" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "hops-${{ needs.check-version.outputs.version }}-macos-arm64.dmg" \
            "Hops.app" || true
          
          if [ ! -f "hops-${{ needs.check-version.outputs.version }}-macos-arm64.dmg" ]; then
            hdiutil create -volname "Hops" -srcfolder "Hops.app" -ov -format UDZO "hops-${{ needs.check-version.outputs.version }}-macos-arm64.dmg"
          fi

      - name: Upload DMG to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          files: hops-${{ needs.check-version.outputs.version }}-macos-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
